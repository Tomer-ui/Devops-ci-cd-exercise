pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
    } 
    
    environment {
        VENV = "${WORKSPACE}/venv"
        REPORTS_DIR = "${WORKSPACE}/reports"
    }
    
    stages {
        stage('Initialize') {
            steps {
                script {
                    System.setProperty("hudson.model.DirectoryBrowserSupport.CSP", "")
                    sh "mkdir -p ${REPORTS_DIR}"
                    
                    // Get the next version from our python script
                    def newVersion = sh(script: "python3 scripts/semver.py", returnStdout: true).trim()
                    if (!newVersion) { error "Versioning script failed!" }
                    
                    env.BUILD_VERSION = newVersion
                    currentBuild.displayName = "#${env.BUILD_NUMBER} (${newVersion})"
                }
            }
        }
        
        stage('Setup Dependencies') {
            steps {
                sh '''
                    python3 -m venv ${VENV}
                    . ${VENV}/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Tests') {
            steps {
                script {
                    // Running Unit Tests with catchError to allow reporting even on failure
                    catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                        sh ". ${VENV}/bin/activate && pytest tests/unit --html=${REPORTS_DIR}/unit_report.html --self-contained-html"
                    }
                    
                    // Only run following tests if previous stages haven't failed the build
                    if (currentBuild.result == null || currentBuild.result == 'SUCCESS') {
                        sh ". ${VENV}/bin/activate && pytest tests/integration --html=${REPORTS_DIR}/integration_report.html --self-contained-html"
                        sh ". ${VENV}/bin/activate && pytest tests/e2e --html=${REPORTS_DIR}/e2e_report.html --self-contained-html"
                    }
                }
            }
        }

        stage('Build & Release') {
            when { expression { return currentBuild.result == null || currentBuild.result == 'SUCCESS' } }
            steps {
                script {
                    // 1. Push to DockerHub (Using single quotes for shell variables)
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh '''
                            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                            docker build -t "$DOCKER_USER/devops-exercise:${BUILD_VERSION}" -f docker/Dockerfile .
                            docker push "$DOCKER_USER/devops-exercise:${BUILD_VERSION}"
                            docker tag "$DOCKER_USER/devops-exercise:${BUILD_VERSION}" "$DOCKER_USER/devops-exercise:latest"
                            docker push "$DOCKER_USER/devops-exercise:latest"
                        '''
                    }

                    // 2. Push Git Tag (Crucial for semver.py to work next time)
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        sh """
                            git config user.email "jenkins@tomas-pc"
                            git config user.name "Jenkins CI"
                            git remote set-url origin https://${GITHUB_TOKEN}@github.com/Tomer-ui/Devops-ci-cd-exercise.git
                            git tag -a "v${env.BUILD_VERSION}" -m "Release v${env.BUILD_VERSION}"
                            git push origin "v${env.BUILD_VERSION}"
                        """
                        
                        // 3. Create GitHub Release
                        def jsonPayload = """
                            {
                              "tag_name": "v${env.BUILD_VERSION}",
                              "target_commitish": "dev",
                              "name": "v${env.BUILD_VERSION}",
                              "body": "Automated release from Jenkins Build #${env.BUILD_NUMBER}",
                              "draft": false, "prerelease": false
                            }
                        """
                        writeFile file: 'release.json', text: jsonPayload
                        sh '''
                            curl -X POST -H "Authorization: token ${GITHUB_TOKEN}" \
                                 -H "Accept: application/vnd.github.v3+json" \
                                 https://api.github.com/repos/Tomer-ui/Devops-ci-cd-exercise/releases -d @release.json
                        '''
                    }
                }
            }
        }

        stage('Post Actions') {
            steps {
                script {
                    publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'unit_report.html', reportName: 'Unit Test Report'])
                    publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'integration_report.html', reportName: 'Integration Test Report'])
                    
                    if (currentBuild.result == 'SUCCESS' || currentBuild.result == null) {
                        slackSend (color: '#00FF00', message: "✅ SUCCESS: v${env.BUILD_VERSION} is live!")
                    } else {
                        slackSend (color: '#FF0000', message: "❌ FAILURE: Build #${env.BUILD_NUMBER} failed.")
                    }
                }
            }
        }
    }

    post {
        cleanup {
            script {
                cleanWs()
            }
        }
    }
}