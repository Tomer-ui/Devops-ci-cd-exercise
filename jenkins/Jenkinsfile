pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
    } 
    
    environment {
        VENV = "${WORKSPACE}/venv"
        REPORTS_DIR = "${WORKSPACE}/reports"
    }
    
    stages {
        stage('Initialize') {
            steps {
                script {
                    System.setProperty("hudson.model.DirectoryBrowserSupport.CSP", "")
                    sh "mkdir -p ${REPORTS_DIR}"
                    def newVersion = sh(script: "python3 scripts/semver.py", returnStdout: true).trim()
                    env.BUILD_VERSION = newVersion
                    currentBuild.displayName = "#${env.BUILD_NUMBER} (${newVersion})"
                }
            }
        }
        
        stage('Setup Dependencies') {
            steps {
                sh '''
                    python3 -m venv ${VENV}
                    . ${VENV}/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Unit Tests') {
            steps {
                // This block is what allows the pipeline to keep moving to "Post Actions"
                catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                    sh '''
                        . ${VENV}/bin/activate
                        pytest tests/unit \
                            --cov=app \
                            --cov-report=html:${REPORTS_DIR}/coverage \
                            --html=${REPORTS_DIR}/unit_report.html \
                            --self-contained-html
                    '''
                }
            }
        }

        // These stages will be skipped if Unit Tests set the buildResult to FAILURE
        stage('Integration Tests') {
            when { attribution { return currentBuild.result == null || currentBuild.result == 'SUCCESS' } }
            steps {
                sh ". ${VENV}/bin/activate && pytest tests/integration --html=${REPORTS_DIR}/integration_report.html --self-contained-html"
            }
        }

        stage('E2E Tests') {
            when { attribution { return currentBuild.result == null || currentBuild.result == 'SUCCESS' } }
            steps {
                sh ". ${VENV}/bin/activate && pytest tests/e2e --html=${REPORTS_DIR}/e2e_report.html --self-contained-html"
            }
        }

        stage('Post Actions') {
            // No 'when' block needed here; it runs by default because the previous stages didn't 'abort' the flow
            steps {
                script {
                    // 1. Publish the reports
                    publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'unit_report.html', reportName: 'Unit Test Report'])
                    publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'integration_report.html', reportName: 'Integration Test Report'])

                    // 2. Notification Logic
                    if (currentBuild.result == 'SUCCESS' || currentBuild.result == null) {
                        slackSend (color: '#00FF00', message: "✅ SUCCESS: Build #${env.BUILD_NUMBER} passed!")
                    } else {
                        // This will now trigger because catchError allowed the pipeline to reach this point
                        slackSend (color: '#FF0000', message: "❌ FAILURE: Build #${env.BUILD_NUMBER} failed. Check: ${env.BUILD_URL}")
                        
                        jiraNewIssue (
                            site: 'JiraLocal', 
                            issue: [
                                fields: [
                                    project: [ key: 'DEV' ], 
                                    summary: "Build Failure: DevOps-Exercise #${env.BUILD_NUMBER}", 
                                    description: "The pipeline found errors. Link: ${env.BUILD_URL}",
                                    issuetype: [ name: 'Bug' ]
                                ]
                            ]
                        )
                    }
                }
            }
        }
    } 

    post {
        cleanup {
            cleanWs()
        }
    }
}