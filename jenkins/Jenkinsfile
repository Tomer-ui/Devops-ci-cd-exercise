pipeline {
    agent any 
    
    environment {
        VENV = "${WORKSPACE}/venv"
        REPORTS_DIR = "${WORKSPACE}/reports"
    }
    
    stages {
        stage('Initialize') {
            steps {
                script {
                    sh "mkdir -p ${REPORTS_DIR}"
                    // Calculate Version
                    def newVersion = sh(script: "python3 scripts/semver.py", returnStdout: true).trim()
                    env.BUILD_VERSION = newVersion
                    currentBuild.displayName = "#${env.BUILD_NUMBER} (${newVersion})"
                }
            }
        }
        
        stage('Setup Dependencies') {
            steps {
                sh '''
                    python3 -m venv ${VENV}
                    . ${VENV}/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        // 1. UNIT TESTS
        stage('Unit Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    echo "Running Unit Tests..."
                    pytest tests/unit \
                        --cov=app \
                        --cov-report=html:${REPORTS_DIR}/coverage \
                        --html=${REPORTS_DIR}/unit_report.html \
                        --self-contained-html
                '''
            }
        }

        // 2. INTEGRATION TESTS (Only runs if Unit passes)
        stage('Integration Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    echo "Running Integration Tests..."
                    pytest tests/integration \
                        --html=${REPORTS_DIR}/integration_report.html \
                        --self-contained-html
                '''
            }
        }

        // 3. E2E TESTS (Only runs if Integration passes)
        stage('E2E Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    echo "Running E2E Tests..."
                    pytest tests/e2e \
                        --html=${REPORTS_DIR}/e2e_report.html \
                        --self-contained-html
                '''
            }
        }

        // 4. PERFORMANCE TESTS (Only runs if E2E passes)
        stage('Performance Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    echo "Running Performance Tests..."
                    python3 main.py &
                    APP_PID=$!
                    sleep 3
                    
                    locust -f tests/performance/locustfile.py \
                        --headless \
                        --users 5 \
                        --spawn-rate 1 \
                        --run-time 10s \
                        --host http://localhost:5000 \
                        --html ${REPORTS_DIR}/performance_report.html
                        
                    kill $APP_PID
                '''
            }
        }
        
        // PLACEHOLDER FOR BYTE 5: Release Stage (Will only run if we get here)
    }
    
    post {
        always {
            // This runs regardless of success/failure so you can see WHAT failed
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'unit_report.html', reportName: 'Unit Test Report'])
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'integration_report.html', reportName: 'Integration Test Report'])
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'e2e_report.html', reportName: 'E2E Test Report'])
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'performance_report.html', reportName: 'Performance Report'])
        }
        
        // PLACEHOLDER FOR BYTE 6: Failure Notification
        // failure {
        //     slackSend ...
        //     jiraSend ...
        // }
    }
}