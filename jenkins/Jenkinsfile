pipeline {
    agent any

    options {
        // This keeps the volume lean by deleting old build history
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
    } 
    
    environment {
        VENV = "${WORKSPACE}/venv"
        REPORTS_DIR = "${WORKSPACE}/reports"
    }
    
    stages {
        stage('Initialize') {
            steps {
                script {
                    // "Unlock" HTML reports CSS/JS for this session
                    System.setProperty("hudson.model.DirectoryBrowserSupport.CSP", "")
                    
                    sh "mkdir -p ${REPORTS_DIR}"
                    
                    // Calculate Version
                    def newVersion = sh(script: "python3 scripts/semver.py", returnStdout: true).trim()
                    env.BUILD_VERSION = newVersion
                    currentBuild.displayName = "#${env.BUILD_NUMBER} (${newVersion})"
                }
            }
        }
        
        stage('Setup Dependencies') {
            steps {
                sh '''
                    python3 -m venv ${VENV}
                    . ${VENV}/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Unit Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    pytest tests/unit \
                        --cov=app \
                        --cov-report=html:${REPORTS_DIR}/coverage \
                        --html=${REPORTS_DIR}/unit_report.html \
                        --self-contained-html
                '''
            }
        }

        stage('Integration Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    pytest tests/integration \
                        --html=${REPORTS_DIR}/integration_report.html \
                        --self-contained-html
                '''
            }
        }

        stage('E2E Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    pytest tests/e2e \
                        --html=${REPORTS_DIR}/e2e_report.html \
                        --self-contained-html
                '''
            }
        }

        stage('Performance Tests') {
            steps {
                sh '''
                    . ${VENV}/bin/activate
                    python3 main.py &
                    APP_PID=$!
                    sleep 3
                    locust -f tests/performance/locustfile.py --headless --users 5 --spawn-rate 1 --run-time 10s --host http://localhost:5000 --html ${REPORTS_DIR}/performance_report.html
                    kill $APP_PID
                '''
            }
        }
        
        stage('Build & Release') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh """
                            echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                            docker build -t \$DOCKER_USER/devops-exercise:${env.BUILD_VERSION} -f docker/Dockerfile .
                            docker push \$DOCKER_USER/devops-exercise:${env.BUILD_VERSION}
                            docker tag \$DOCKER_USER/devops-exercise:${env.BUILD_VERSION} \$DOCKER_USER/devops-exercise:latest
                            docker push \$DOCKER_USER/devops-exercise:latest
                        """
                    }
                    
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        def jsonPayload = """
                            {
                              "tag_name": "v${env.BUILD_VERSION}",
                              "target_commitish": "dev",
                              "name": "v${env.BUILD_VERSION}",
                              "body": "Automated release from Jenkins Build #${env.BUILD_NUMBER}",
                              "draft": false,
                              "prerelease": false
                            }
                        """
                        writeFile file: 'release.json', text: jsonPayload
                        sh "curl -X POST -H 'Authorization: token ${GITHUB_TOKEN}' -H 'Accept: application/vnd.github.v3+json' https://api.github.com/repos/Tomer-ui/Devops-ci-cd-exercise/releases -d @release.json"
                    }
                }
            }
        }
    } 

    post {
        always {
            // Publish the HTML reports to the Sidebar
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'unit_report.html', reportName: 'Unit Test Report'])
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'integration_report.html', reportName: 'Integration Test Report'])
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'e2e_report.html', reportName: 'E2E Test Report'])
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'reports', reportFiles: 'performance_report.html', reportName: 'Performance Report'])
        }
        
        success {
            // GREEN notification
            slackSend (
                color: '#00FF00', 
                message: "‚úÖ SUCCESS: Build #${env.BUILD_NUMBER} (${env.BUILD_VERSION}) passed!\nArtifact pushed to DockerHub.\nRelease created on GitHub.\nSee: ${env.BUILD_URL}"
            )
        }
        
        failure {
            script {
                // Construct variables for the Sidebar links
                // Note: Jenkins HTML Publisher replaces spaces with %20 in URLs
                def projectDashboard = "${env.JOB_URL}"
                def unitUrl = "${env.BUILD_URL}Unit_20Test_20Report/"
                def intUrl = "${env.BUILD_URL}Integration_20Test_20Report/"
                def e2eUrl = "${env.BUILD_URL}E2E_20Test_20Report/"

                // RED notification
                slackSend (
                    color: '#FF0000', 
                    message: "‚ùå FAILURE: Build #${env.BUILD_NUMBER} stopped.\n" + 
                             "üìä Dashboard: ${projectDashboard}\n" +
                             "üîç Reports: <${unitUrl}|Unit> | <${intUrl}|Integration> | <${e2eUrl}|E2E>"
                )
                
                // Jira Ticket
                jiraNewIssue (
                    site: 'JiraLocal', 
                    issue: [
                        fields: [
                            project: [ key: 'DEV' ], 
                            summary: "Build Failure: DevOps-Exercise #${env.BUILD_NUMBER}", 
                            description: "The pipeline stopped due to a failure.\n\nCheck the Stage View Dashboard: ${projectDashboard}\nDirect Link to Build #${env.BUILD_NUMBER}: ${env.BUILD_URL}",
                            issuetype: [ name: 'Bug' ]
                        ]
                    ]

                )
            }
        }

        cleanup {
            script {
                // IMPORTANT: Remove the docker image from your local machine to save space
                try {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh "docker rmi \$DOCKER_USER/devops-exercise:${env.BUILD_VERSION} || true"
                        sh "docker rmi \$DOCKER_USER/devops-exercise:latest || true"
                    }
                } catch (e) {
                    echo "Cleanup warning: ${e}"
                }
                cleanWs()
            }
        }
    }
}